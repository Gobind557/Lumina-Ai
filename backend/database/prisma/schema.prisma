generator client {
  provider = "prisma-client-js"
}

generator clientApi {
  provider = "prisma-client-js"
  output   = "../../api/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  user
}

enum EmailStatus {
  PENDING_SEND
  SENT
  FAILED
  BOUNCED
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String?
  firstName    String?
  lastName     String?
  role         UserRole      @default(user)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  drafts       EmailDraft[]
  emails       Email[]
  oauth        OAuthConnection[]
  templates    Template[]
  campaigns    Campaign[]
}

model OAuthConnection {
  id            String   @id @default(uuid())
  userId        String
  provider      String
  emailAddress  String
  accessToken   String
  refreshToken  String?
  tokenExpiresAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])
}

model EmailDraft {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String?
  prospectId  String?
  subject     String?
  bodyHtml    String?
  bodyText    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  prospect  Prospect? @relation(fields: [prospectId], references: [id])
  emails    Email[]
}

model Prospect {
  id           String   @id @default(uuid())
  workspaceId  String?
  email        String
  firstName    String?
  lastName     String?
  company      String?
  jobTitle     String?
  customFields Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  drafts            EmailDraft[]
  emails            Email[]
  campaignProspects CampaignProspect[]
}

enum CampaignProspectStatus {
  ACTIVE
  REPLIED
}

model CampaignProspect {
  id          String                @id @default(uuid())
  campaignId  String
  prospectId  String
  status      CampaignProspectStatus @default(ACTIVE)
  currentStep Int                   @default(0)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prospect Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  @@unique([campaignId, prospectId])
  @@index([campaignId])
  @@index([prospectId])
}

model CompanyData {
  id        String   @id @default(uuid())
  domain    String   @unique
  name      String?
  industry  String?
  size      String?
  location  String?
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Email {
  id               String      @id @default(uuid())
  draftId          String?
  userId           String
  workspaceId      String?
  prospectId       String?
  campaignId       String?
  fromEmail        String
  toEmail          String
  subject          String
  bodyHtml         String
  bodyText         String?
  status           EmailStatus @default(PENDING_SEND)
  idempotencyKey   String      @unique
  providerMessageId String?
  sentAt           DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  user       User            @relation(fields: [userId], references: [id])
  draft      EmailDraft?     @relation(fields: [draftId], references: [id])
  prospect   Prospect?       @relation(fields: [prospectId], references: [id])
  campaign   Campaign?       @relation(fields: [campaignId], references: [id])
  openEvents EmailOpenEvent[]
  replyEvents EmailReplyEvent[]
}

model EmailOpenEvent {
  id        String   @id @default(uuid())
  emailId   String
  openedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  email Email @relation(fields: [emailId], references: [id], onDelete: Cascade)
  @@index([emailId])
  @@index([openedAt])
}

model EmailReplyEvent {
  id        String   @id @default(uuid())
  emailId   String
  repliedAt DateTime @default(now())
  replySubject String?
  replyBody   String?
  createdAt DateTime @default(now())

  email Email @relation(fields: [emailId], references: [id], onDelete: Cascade)
  @@index([emailId])
  @@index([repliedAt])
}

model Template {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String?
  title       String
  description String
  content     String
  category    String
  tone        String?
  usedCount   Int      @default(0)
  openRate    Int?
  replyRate   Int?
  isFavorite  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

model Campaign {
  id          String         @id @default(uuid())
  userId      String
  workspaceId String?
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user               User               @relation(fields: [userId], references: [id])
  emails             Email[]
  campaignProspects  CampaignProspect[]
  @@index([userId])
  @@index([status])
  @@index([startDate])
}
